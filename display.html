<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>DieUhr</title>
<link href="display.css" rel="stylesheet"/>
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/clock.js"></script>
<script type="text/javascript" src="js/countdown.js"></script>
<style type="text/css">
body {
	background: gray;
}

#wrap {
	height:56.25vw;
    width: 100vw;
	position:absolute;
	left:0; right:0; top:0; bottom:0;
	font-size: 28vw;
}
</style>

</head>
<body>
	<div id="wrap">
		<div id="center">
			<div id="printUpperLine"></div>
			<div id="printLowerLine"></div>
		</div>	
	</div>
<script type="text/javascript" src="js/function.js"></script>
<script>
var local  = { };
var temp   = { };
var remote = { };

var timeoutState = "stop";
var timerID;
var countdownID;
remote.countdownState = "stop";
local.tab = 'Live';



function checkTimer() {
	//console.log('checkTimer '+timeoutState)
	if (timeoutState == "stop" && remote.onOff == "on" && remote.timeout != "inf" && remote.countdownState == "stop") {
		timeoutState = "run";
		console.log('Set global timeout with '+ remote.timeout+' seconds');
		clearTimeout(timerID);
		clearTimeout(countdownID);
		timerID = setTimeout(function() {
			temp.onOff = "off";
			sendDisplay(temp);
			timeoutState = "stop";
		}, remote.timeout * 1000);
	}
	if (remote.onOff == "off" && timeoutState == "run") {
		timeoutState = "stop";
	}
}

function checkCountdown() {
	console.log('remote.countdownEndtime '+remote.countdownEndtime)
	if (remote.countdownState == "start" && remote.onOff == "on") {
		temp.countdownState = "runing";
		timeoutState = "stop";
		clearTimeout(timerID);
		clearTimeout(countdownID);
		temp.countdownEndtime = setCountdown(remote.countdown);
		remote.countdownEndtime = temp.countdownEndtime; //avoid showing old value for a glimbs 
		sendDisplay(temp);
		temp = { };
	}
	
	if (remote.countdownState == "runing" ) {
		var t = getTimeRemaining(remote.countdownEndtime);
		if (t.total == 0) { 	//set countdown timeout
			console.log('Set timeout after countdown with '+ remote.countdownTimeout+' seconds');
			countdownID = setTimeout(function() {
				temp.onOff = "off";
				temp.countdownState = "stop";
				sendDisplay(temp);
			}, remote.countdownTimeout * 1000);
		}
	}

}

function timeloop() {
	$.ajax({
	url: "data.json",
	cache: false
	})
	.done(function(response) {
		remote = response;
		if (remote.checkOption == '1') { // handel option change
			local.preUpperLine = '';
			local.preLowerLine = '';
			temp.checkOption  = '2';
			sendDisplay(temp);
			temp = { };
		}
		if (remote.onOff == "off") {
			clearTimeout(timerID);
			clearTimeout(countdownID);
		}
		checkCountdown();
		checkTimer();
		checkDisplay(remote);
	})
	setTimeout("timeloop()",1000);
};

timeloop();
</script>
</body>
</html>
